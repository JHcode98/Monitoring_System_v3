<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Documents Charts</title>
    <link rel="stylesheet" href="styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      .charts-wrap{max-width:1100px;margin:18px auto;padding:12px;display:grid;grid-template-columns:1fr;gap:18px}
      .chart-card{background:#fff;border-radius:8px;padding:12px;border:1px solid #eef6ff}
      .chart-row{display:flex;gap:14px;flex-wrap:wrap}
      canvas{max-width:100%;height:360px}
    </style>
  </head>
  <body>
    <header>
      <h1>Document Visualizations</h1>
      <nav>
        <a href="index.html">Dashboard</a> â€¢
        <a href="documents_full.html">Full Docs</a>
      </nav>
    </header>

    <main class="charts-wrap">
      <section class="chart-card">
        <h2>By Title</h2>
        <canvas id="chart-title"></canvas>
      </section>

      <section class="chart-card">
        <h2>By Owner</h2>
        <canvas id="chart-owner"></canvas>
      </section>
    </main>

    <footer style="text-align:center;margin-top:18px">
      <small>Generated from local data or API.</small>
    </footer>

    <script>
      const STORAGE_KEY = 'dms_docs_v1';

      async function loadDocs(){
        // Prefer API if available, otherwise fallback to localStorage
        try{
          const base = (typeof API_BASE !== 'undefined' && API_BASE) ? API_BASE : '';
          const res = await fetch(base + '/api/docs', {cache: 'no-store'});
          if(res && res.ok){
            const json = await res.json();
            if(Array.isArray(json) && json.length) return json;
          }
        }catch(e){ /* ignore and fallback */ }

        try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') || []; }
        catch(e){ return []; }
      }

      function aggregateCount(items, keyFn){
        const map = Object.create(null);
        items.forEach(it => {
          const k = (keyFn(it) || 'Unknown').trim() || 'Unknown';
          map[k] = (map[k] || 0) + 1;
        });
        return map;
      }

      // Summarize map to top N keys, grouping the rest into 'Other'
      function summarizeMap(map, topN = 10){
        const entries = Object.entries(map).sort((a,b)=>b[1]-a[1]);
        if(entries.length <= topN) return entries;
        const top = entries.slice(0, topN);
        const other = entries.slice(topN).reduce((s,[_k,v]) => s+v, 0);
        top.push(['Other', other]);
        return top;
      }

      function renderBar(ctx, labels, data, title, color){
        return new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{ label: title, data: data, backgroundColor: color || 'rgba(54,162,235,0.6)' }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false }, tooltip: { mode: 'index' } },
            scales: {
              x: { ticks: { maxRotation: 45, autoSkip: true }, grid: { display: false } },
              y: { beginAtZero: true }
            }
          }
        });
      }

      (async ()=>{
        const docs = await loadDocs();
        const byTitle = aggregateCount(docs, d => d.title || 'Unknown');
        const byOwner = aggregateCount(docs, d => d.owner || 'Unknown');

        const topTitles = summarizeMap(byTitle, 10);
        const titleLabels = topTitles.map(e => e[0]);
        const titleData = topTitles.map(e => e[1]);

        const topOwners = summarizeMap(byOwner, 10);
        const ownerLabels = topOwners.map(e => e[0]);
        const ownerData = topOwners.map(e => e[1]);

        const ctxTitle = document.getElementById('chart-title').getContext('2d');
        const ctxOwner = document.getElementById('chart-owner').getContext('2d');

        renderBar(ctxTitle, titleLabels, titleData, 'Documents by Title', 'rgba(75,192,192,0.6)');
        renderBar(ctxOwner, ownerLabels, ownerData, 'Documents by Owner', 'rgba(153,102,255,0.6)');
      })();
    </script>
  </body>
</html>
