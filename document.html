<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Document Details</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .doc-detail{max-width:820px;margin:22px auto;padding:16px}
      .doc-row{display:flex;gap:12px;margin-bottom:10px}
      .doc-label{width:160px;color:var(--muted);font-weight:700}
      pre.notes{white-space:pre-wrap;background:#fbfdff;padding:8px;border-radius:6px}
      .back-link{display:inline-block;margin-bottom:12px}
    </style>
  </head>
  <body>
    <header>
      <h1>Document Details</h1>
      <div class="navbar" role="navigation">
        <div class="nav-left">
          <a href="documents_full.html" id="documents-full-page-btn" class="nav-btn" title="Open Full Documents View">Full Docs</a>
          <a href="admin_inbox.html" id="admin-inbox-page-btn" class="nav-btn" style="display:none" title="Open Admin Inbox Page">Admin Inbox</a>
        </div>
        <button class="nav-toggle" id="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">
          <span class="bar"></span>
          <span class="bar"></span>
          <span class="bar"></span>
        </button>
        <div class="nav-right">
          <div id="clock" class="clock" aria-live="polite"></div>
          <div id="sr-status" class="sr-only" aria-live="polite" aria-atomic="true"></div>
          <div class="nav-user" id="nav-user">
            <a class="user-btn" id="user-btn" href="profile.html"><span id="nav-avatar" class="avatar small" style="margin-right:8px"></span><span id="username-display"></span> <span id="role-badge" class="role-badge" style="display:none;margin-left:8px"></span></a>
            <div class="user-menu" id="user-menu" role="menu" aria-label="User menu">
              <a href="profile.html" id="profile-btn" role="menuitem">Profile</a>
              <button id="logout-btn" role="menuitem">Logout</button>
            </div>
          </div>
        </div>
      </div>
    </header>

    <main class="doc-detail card">
      <a class="back-link" href="index.html">‚Üê Back to Dashboard</a>
      <div id="not-found" class="muted hidden">Document not found.</div>

      <div id="doc-content" class="hidden">
        <form id="doc-edit-form">
          <div class="doc-row"><div class="doc-label">Control #</div><div><input id="edit-control" name="controlNumber" required /></div></div>
          <div class="doc-row"><div class="doc-label">Title</div><div>
            <select id="edit-title" name="title">
              <option>Cycle Count</option>
              <option>Retrieval Concerns</option>
              <option>B1T1 Adj</option>
              <option>LBR</option>
              <option>Rejected Claims</option>
              <option>SIS</option>
              <option>Expired</option>
              <option>Damaged</option>
              <option>Manual Picked</option>
              <option>Receiving Error</option>
              <option>Other</option>
            </select>
            <input id="edit-title-other" name="titleOther" placeholder="Other title" style="display:none;margin-top:6px" />
          </div></div>
          <div class="doc-row"><div class="doc-label">Owner</div><div><input id="edit-owner" name="owner" /></div></div>
          <div class="doc-row"><div class="doc-label">Status</div><div><select id="edit-status" name="status"><option>Revision</option><option>Routing</option><option>Approved</option><option>Rejected</option></select></div></div>
          <div class="doc-row"><div class="doc-label">WINS Status</div><div><select id="edit-wins" name="winsStatus"><option>Approved</option><option>Pending for Approve</option><option>Rejected</option></select></div></div>
          <div class="doc-row"><div class="doc-label">Created</div><div><input id="edit-created" name="createdAt" type="datetime-local" /></div></div>
          <div class="doc-row"><div class="doc-label">Notes</div><div><textarea id="edit-notes" name="notes" rows="6"></textarea></div></div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <button type="submit">Save Changes</button>
            <button type="button" id="export-pdf-btn">Export PDF</button>
            <a href="index.html">Cancel</a>
          </div>
          <input type="hidden" id="original-control" />
        </form>
      </div>
    </main>

    <footer>
      <small><a href="index.html">Dashboard</a></small>
    </footer>

    <script>
      const STORAGE_KEY = 'dms_docs_v1';
      function queryParam(name){
        // profile moved to profile.html
        const u = new URL(location.href);
        return u.searchParams.get(name);
      }
      function formatDate(ms){
        if(!ms) return '';
        const d = new Date(Number(ms));
        return d.toLocaleString();
      }
      function msToDatetimeLocal(ms){
        if(!ms) return '';
        const d = new Date(Number(ms));
        const pad = n => String(n).padStart(2,'0');
        const yyyy = d.getFullYear();
        const mm = pad(d.getMonth()+1);
        const dd = pad(d.getDate());
        const hh = pad(d.getHours());
        const min = pad(d.getMinutes());
        return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
      }
      function datetimeLocalToMs(val){
        if(!val) return null;
        const d = new Date(val);
        if(isNaN(d.getTime())) return null;
        return d.getTime();
      }

      document.addEventListener('DOMContentLoaded', ()=>{
        const ctl = queryParam('control');
        if(!ctl){ document.getElementById('not-found').classList.remove('hidden'); return; }
        let docs = [];
        try{ docs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }catch(e){ docs = []; }
        const doc = docs.find(d => d.controlNumber === ctl);
        if(!doc){ document.getElementById('not-found').classList.remove('hidden'); return; }

        // populate editable form
        document.getElementById('doc-content').classList.remove('hidden');
        document.getElementById('edit-control').value = doc.controlNumber || '';
        document.getElementById('original-control').value = doc.controlNumber || '';
        // set title select / other
        try{
          const sel = document.getElementById('edit-title');
          const other = document.getElementById('edit-title-other');
          if(sel){
            const opts = Array.from(sel.options).map(o => o.value);
            if(opts.includes(doc.title)){
              sel.value = doc.title;
              if(other) other.style.display = 'none';
            } else {
              sel.value = 'Other';
              if(other){ other.style.display = ''; other.value = doc.title || ''; }
            }
          }
        }catch(e){}
        document.getElementById('edit-owner').value = doc.owner || '';
        document.getElementById('edit-status').value = doc.status || 'Revision';
        document.getElementById('edit-wins').value = doc.winsStatus || 'Pending for Approve';
        document.getElementById('edit-created').value = msToDatetimeLocal(doc.createdAt);
        document.getElementById('edit-notes').value = doc.notes || '';

        // wire change to toggle other input
        try{
          const sel = document.getElementById('edit-title');
          const other = document.getElementById('edit-title-other');
          if(sel){ sel.addEventListener('change', () => { if(other) other.style.display = (sel.value === 'Other') ? '' : 'none'; }); }
        }catch(e){}

        const form = document.getElementById('doc-edit-form');
        form.addEventListener('submit', e => {
          e.preventDefault();
          const controlNumber = document.getElementById('edit-control').value.trim();
          const original = document.getElementById('original-control').value || '';
          // title may be a select with Other
          let title = '';
          try{
            const sel = document.getElementById('edit-title');
            if(sel && sel.tagName === 'SELECT'){
              if(sel.value === 'Other'){ const oth = document.getElementById('edit-title-other'); title = oth ? (oth.value||'').trim() : ''; }
              else title = (sel.value || '').trim();
            } else { title = (document.getElementById('edit-title').value || '').trim(); }
          }catch(e){ title = (document.getElementById('edit-title').value || '').trim(); }
          const owner = document.getElementById('edit-owner').value.trim();
          const status = document.getElementById('edit-status').value;
          const winsStatus = document.getElementById('edit-wins').value;
          const notes = document.getElementById('edit-notes').value.trim();
          const createdVal = document.getElementById('edit-created').value || '';
          const createdMs = datetimeLocalToMs(createdVal);

          if(!controlNumber || !title){ alert('Control number and title are required'); return; }
          const ctrlRe = /^ECOM-\d{4}-\d{4}$/;
          if(!ctrlRe.test(controlNumber)){ alert('Control Number must follow ECOM-YYYY-NNNN'); return; }

          // ensure unique if changed
          if(controlNumber !== original && docs.find(d => d.controlNumber === controlNumber)){
            alert('A document with that control number already exists. Choose another.');
            return;
          }

          const idx = docs.findIndex(d => d.controlNumber === original);
          const createdAtFinal = createdMs || (idx >= 0 ? docs[idx].createdAt : Date.now());
          const entry = { controlNumber, title, owner, status, winsStatus, notes, createdAt: createdAtFinal, updatedAt: Date.now() };

          if(idx >= 0){
            if(controlNumber !== original) { docs.splice(idx,1); docs.unshift(entry); }
            else { docs[idx] = entry; }
          } else { docs.unshift(entry); }

          try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(docs)); }catch(e){ alert('Failed to save: ' + e.message); return; }
          alert('Saved');
          // redirect back to dashboard (optional)
          window.location.href = 'index.html';
        });
      });
    </script>
    <!-- html2canvas and jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
      // PDF export using html2canvas + jsPDF
      async function exportDocToPDF(){
        const btn = document.getElementById('export-pdf-btn');
        if(!btn) return;
        btn.disabled = true; btn.textContent = 'Generating...';
        const el = document.querySelector('.doc-detail');
        try{
          if(typeof html2canvas === 'undefined'){ throw new Error('html2canvas library not loaded'); }
          if(!window.jspdf || typeof window.jspdf.jsPDF !== 'function'){ throw new Error('jsPDF library not loaded'); }
          const canvas = await html2canvas(el, {scale:2});
          const imgData = canvas.toDataURL('image/png');
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF('p','pt','a4');
          const imgProps = pdf.getImageProperties(imgData);
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
          pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
          const filename = (document.getElementById('edit-control')?.value || 'document') + '.pdf';
          pdf.save(filename);
        }catch(err){
          alert('PDF export failed: ' + (err && err.message ? err.message : err));
        }finally{
          btn.disabled = false; btn.textContent = 'Export PDF';
        }
      }
      document.addEventListener('DOMContentLoaded', ()=>{
        const pdfBtn = document.getElementById('export-pdf-btn');
        if(pdfBtn) pdfBtn.addEventListener('click', exportDocToPDF);
      });
    </script>
  </body>
</html>
